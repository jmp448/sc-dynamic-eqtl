---
title: "Cell Type Annotation"
output: html_notebook
---

```{r libloader, warning=FALSE, echo=FALSE, message=FALSE}
library(Seurat)
library(Nebulosa)
library(tidyverse)
library(Matrix)
library(RColorBrewer)
library(scales)
```

```{r file_load, echo=FALSE, warning=FALSE, message=FALSE}
sc <- readRDS("data/seurat.annotated.rds")
#sc_cardiac <- readRDS("data/seurat.cardiac.rds")
```

Louvain clustering (resolution 0.15) identifies subpopulations of cells present in the data
```{r clustering, warning=FALSE, message=FALSE, echo=FALSE}
DimPlot(sc, group.by="diffday", pt.size=0.75)
DimPlot(sc, group.by="type", pt.size=0.75)
table(sc$seurat_clusters)
```

We can look at marker genes to map these clusters to the predominant cell types in this differentiation
*IPSC* - induced pluripotent stem cells (POU5F1)
*MES* - early mesoderm (MIXL1)
*CMES* - cardiac mesoderm (MESP1)
*PROG* - cardiac progenitor (ISL1)
*CM* - cardiomyocyte (TNNT2)
*CF* - cardiac fibroblast (COL3A1)
```{r marker_genes, warning=FALSE, message=FALSE, echo=FALSE}
plot_density(sc, "POU5F1")
plot_density(sc, "MIXL1")
plot_density(sc, "MESP1")
plot_density(sc, "GATA4")
plot_density(sc, "TAGLN")
plot_density(sc, "TNNT2")
plot_density(sc, "COL3A1")
plot_density(sc, "APOA1")
```

Using a subset of these marker genes, we can examine how expression changes over time to see that cell lines proceed through differentiation at different rates, and seem to preferentially produce either cardiomyocytes (blue, marker gene TNNT2) or cardiac fibroblasts (purple, marker gene COL3A1).
```{r ct_prefs, warning=FALSE, message=FALSE, echo=FALSE}
meta <- as_tibble(sc@meta.data[,c("diffday", "individual")], rownames="cell")
rep.genes <- c("TNNT2", "COL3A1")
rep.inds <- c("18499", "19209", "18505", "18517", "19127", "19190")
exp.marker <- as_tibble(t(sc[["SCT"]]@data[rep.genes,]), rownames="cell") %>% 
  inner_join(meta, by="cell") %>%
  gather(!c(cell, diffday, individual), key="gene", value="exp")
exp.sub <- exp.marker %>% 
  filter(individual %in% rep.inds) %>%
  mutate(gene=factor(gene, levels=c("TNNT2", "COL3A1"))) %>%
  mutate(individual=factor(individual, levels=rep.inds))
type.cols <- hue_pal()(7)[c(5,6)]
ggplot(exp.sub, aes(x=diffday, y=exp, fill=gene)) +
  geom_violin(position=position_dodge(), trim=T, scale="width") +
  facet_grid(rows=vars(individual)) +
  theme_classic() +
  scale_fill_manual(values=type.cols) +
  xlab("Differentiation Day") +
  ylab("Normalized Expression")
```