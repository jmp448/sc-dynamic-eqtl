---
title: "R Notebook"
output: html_notebook
---

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(patchwork)
```

## Cell Line PCA
```{r, warning=FALSE, message=FALSE}
pseudobulk <- read_tsv("data/cibersort/inputs/pseudobulk_cpm.full.tsv")
bulk <- read_tsv("data/cibersort/inputs/bulk_tpm.full.tsv")
source("code/cell_line_pca.R")
pseudobulk.clpca <- cell.line.pca(pseudobulk)
bulk.clpca <- cell.line.pca(bulk)
```

Compare cell line PCs align between bulk and pseudobulk
```{r}
pb.pcs <- pseudobulk.clpca$cell.line.pcs
colnames(pb.pcs) <- str_replace(colnames(pb.pcs), "PC", "PB_PC")
bulk.pcs <- bulk.clpca$cell.line.pcs
colnames(bulk.pcs) <- str_replace(colnames(bulk.pcs), "PC", "Bulk_PC")
pcplot <- inner_join(pb.pcs, bulk.pcs, by="ind") %>% select(!ind)
pb.pc1.order <- pb.pcs %>% arrange(PB_PC_1) %>% .$ind
bulk.pc1.order <- bulk.pcs %>% arrange(Bulk_PC_1) %>% .$ind
ben.pc1.order <- c("18489", "18907", "19127", "18508", "19108", "19093", "18505", "19159", "18855", "18912", "18520", "18511", "19190", "18858", "18517", "18870", "19193", "18499", "19209")
ggplot(pcplot, aes(x=PB_PC_1, Bulk_PC_1)) + geom_point()
```

## Bulk Deconvolution
Now we can turn to the bulk data, and see what cell type deconvolution tells us
```{r, fig.height=25, fig.width=10}
bulk <- read_tsv("data/cibersort/outputs/seurat_sig_4_bulk.txt") %>%
                  select(!c(`P-value`, Correlation, RMSE))
p3 <- bulk %>% rename(sample=Mixture) %>% mutate(day=str_extract(sample, "[^_]+$")) %>%
        mutate(ind=str_extract(sample, "[^_]+")) %>% 
        gather(!c(sample, day, ind), key="type", value="fraction") %>% 
        mutate(celltype=str_extract(type, "[^_]+")) %>%
        select(!type)
p3$day <- as.numeric(p3$day)
p3$celltype <- factor(p3$celltype, levels=c("iPSC", "mes", "CM", "EPDC"))
p3$ind <- factor(p3$ind, levels=ben.pc1.order)
```

First, look at a subset of three individuals
```{r, warning=FALSE, message=FALSE}
p3.sub <- filter(p3, ind %in% c("18489", "19190", "19209"))
ggplot(p3.sub, aes(x=day, y=fraction, fill=celltype)) +
  geom_area(alpha=0.6 , size=1, colour="black") +
  facet_grid(rows=vars(ind)) +
  theme_classic() + theme(axis.ticks.y = element_blank(), axis.text.y=element_blank())
```
Then look at all individuals together
```{r, warning=FALSE, message=FALSE, fig.width=15, fig.height=10}
p1 <- ggplot(p3, aes(x=day, y=fraction, fill=celltype)) +
  geom_area(alpha=0.6 , size=1, colour="black") +
  facet_grid(rows=vars(ind))+
  theme_classic() + theme(axis.ticks.y = element_blank(), axis.text.y=element_blank())
p1
# p3$ind <- factor(p3$ind, levels=bulk.pc1.order)
# p2 <- ggplot(p3, aes(x=day, y=fraction, fill=celltype)) +
#   geom_area(alpha=0.6 , size=1, colour="black") +
#   facet_grid(rows=vars(ind))+
#   theme_classic() + theme(axis.ticks.y = element_blank(), axis.text.y=element_blank())
# p1 + p2
```
It would appear that cell line PC1 was picking up on differentiation efficiency very well. Does differentiation efficiency remain consistent between differentiations?

Load the pseudobulk data
```{r, warning=FALSE, message=FALSE}
day.ind <- read_tsv("data/cibersort/pseudobulk_samples.tsv")
cell.types <- read_tsv("data/cibersort/pseudobulk_labels.4.tsv")
pb.fracs <- inner_join(day.ind, cell.types, by="cell") %>% `colnames<-`(c("cell", "sample", "cell.type"))
for (s in unique(pb.fracs$sample)) {
  s.fracs <- pb.fracs %>% filter(sample==s) %>% .$cell.type %>% 
              table %>% as.matrix %>% t %>% as_tibble %>%
              mutate("sample"=s)
  if (s == unique(pb.fracs$sample)[1]) {
    ct.counts <- s.fracs
  } else {
    ct.counts <- bind_rows(ct.counts, s.fracs)
  }
}
mix <- ct.counts$sample
ct.counts <- ct.counts %>% select(!sample)
ct.proportions.sub <- ct.counts / rowSums(ct.counts, na.rm=T)
ct.proportions.sub[is.na(ct.proportions.sub)] <- 0
ct.proportions.sub <- ct.proportions.sub %>% mutate(sample=mix) %>% relocate(sample) %>% arrange(sample)
ct.proportions.sub <- ct.proportions.sub %>% mutate(day=str_extract(sample, "[^_]+$")) %>%
        mutate(ind=str_extract(sample, "[^_]+")) %>% 
        gather(!c(sample, day, ind), key="type", value="fraction") %>% 
        mutate(celltype=str_extract(type, "[^_]+")) %>%
        select(!type)
```

```{r, warning=FALSE, message=FALSE, fig.width=15, fig.height=10}
ct.proportions.sub <- as_tibble(ct.proportions.sub) %>% mutate(exp="pseudobulk")
ct.proportions.sub$day <- as.numeric(ct.proportions.sub$day)
ct.proportions.sub$celltype <- factor(ct.proportions.sub$celltype, levels=c("iPSC", "mes", "CM", "EPDC"))
ct.proportions.sub$ind <- factor(ct.proportions.sub$ind, levels=ben.pc1.order)
p3 <- p3 %>% mutate(exp="bulk")
p4 <- bind_rows(ct.proportions.sub, p3)
ggplot(p4, aes(x=day, y=fraction, fill=celltype)) +
  geom_area(alpha=0.6 , size=1, colour="black") +
  facet_grid(rows=vars(ind), cols=vars(exp))+
  theme_classic() + theme(axis.ticks.y = element_blank(), axis.text.y=element_blank())
```